<!doctype html>
<html>
  <head>
    <title>Viitekehysmuunnin</title>
  </head>

  <style>
    .hidden { display: none; }
  </style>
  <body>
    <h1>Viitekehysmuunnin</h1>
    <form method="post" action="http://localhost:3000/upload/" id="upload" name="upload" enctype="multipart/form-data">
      <p><input type="file" name="file" required /></p>
      <p><input type="submit" /></p>
    </form>
    <p id="loading" class="hidden">Ladataan...</p>
    <p><a href="" id="download" class="hidden">Lataa muunnettu tiedosto</a></p>
    <p><a href="/" id="reload" class="hidden">Muunna toinen tiedosto</a></p>
    <p id="error" class="hidden">Tapahtui virhe! Yritä myöhemmin uudelleen</p>
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script>
$(function() {
  var fileName = window.location.hash.substring(1);
  if (fileName) {
    $("#upload").addClass("hidden");
    $("#download").removeClass("hidden").attr("href", downloadUrl(fileName));
    $("#reload").removeClass("hidden");
  }

  $('#upload').on('submit', function(event) {
    event.preventDefault();
    var form = $(this);
    var loader = $("#loading");

    form.addClass('hidden');
    loader.removeClass('hidden');

    var data = new FormData(form[0]);

    $.ajax({
      url: '/upload',
      type: 'POST',
      data: data,
      cache: false,
      processData: false,
      contentType: false
    }).done(function(res) {
      window.location.hash = res;
      pollResponse(res);
    });

    function pollResponse(res) {
        $.ajax("/status/" + res, {
          statusCode: {
            200: function() {
              loader.addClass("hidden");
              $("#download").attr("href", downloadUrl(res)).removeClass("hidden");
              $("#reload").removeClass("hidden");
            },
            202: function() {
              setTimeout(function() { pollResponse(res); }, 1000);
            },
            500: function() {
              loader.addClass("hidden");
              $("#error").removeClass("hidden");
            }
          }
        });
    }
  });
  function downloadUrl(fileName) {
    return "download/" + fileName;
  }
});
    </script>

  </body>
</html>
